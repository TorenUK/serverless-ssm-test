"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _fs = _interopRequireDefault(require("fs"));
var _awsSdk = require("aws-sdk");
var _log = require("@serverless/utils/log");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
class ServerlessSsmPlugin {
  constructor(serverless, options) {
    var _process$env$SECRETS_;
    _defineProperty(this, "hooks", void 0);
    _defineProperty(this, "options", void 0);
    _defineProperty(this, "serverless", void 0);
    _defineProperty(this, "region", void 0);
    _defineProperty(this, "secretsFile", void 0);
    this.hooks = {
      'before:package:createDeploymentArtifacts': this.packageSecrets.bind(this),
      'after:package:createDeploymentArtifacts': this.cleanupPackageSecrets.bind(this),
      'before:deploy:function:packageFunction': this.packageSecrets.bind(this),
      'after:deploy:function:packageFunction': this.cleanupPackageSecrets.bind(this),
      // For serverless-offline plugin
      'before:offline:start:init': this.packageSecrets.bind(this),
      'before:offline:start:end': this.cleanupPackageSecrets.bind(this),
      // For invoke local
      'before:invoke:local:invoke': this.packageSecrets.bind(this),
      'after:invoke:local:invoke': this.cleanupPackageSecrets.bind(this)
    };
    this.options = options;
    this.serverless = serverless;
    this.region = serverless.service.provider.region;
    this.secretsFile = (_process$env$SECRETS_ = process.env.SECRETS_FILE_PATH) !== null && _process$env$SECRETS_ !== void 0 ? _process$env$SECRETS_ : 'secrets.json';
  }
  async writeEnvironmentSecretToFile() {
    const providerSecrets = this.serverless.service.provider.environment['API_ENV_SECRET_NAME'];
    const secrets = {};

    // modify this function to return the secrets
    if (!providerSecrets) {
      throw new this.serverless.classes.Error(`Unable to find the environment variable for ${providerSecrets}`);
    }
    const param = await this.getParameterFromSsm(providerSecrets);
    if (!param) {
      throw new this.serverless.classes.Error(`Unable to load Secret ${providerSecrets}`);
    }
    secrets[providerSecrets] = param;
    return _fs.default.promises.writeFile(this.secretsFile, JSON.stringify(secrets));
  }
  async getParameterFromSsm(name) {
    const client = new _awsSdk.SecretsManager({
      region: this.region,
      ...this.serverless.providers.aws.getCredentials()
    });
    const data = await client.getSecretValue({
      SecretId: name
    }).promise();
    return data.SecretString;
  }
  async cleanupPackageSecrets() {
    (0, _log.log)(`Cleaning up ${this.secretsFile}`);
    if (_fs.default.existsSync(this.secretsFile)) {
      await _fs.default.promises.unlink(this.secretsFile);
    }
  }
  async packageSecrets() {
    var _this$serverless$serv;
    if (this.serverless.service.provider.stage === 'local') {
      (0, _log.log)('Skipping secret packaging due to stage = local');
      return;
    }
    (0, _log.log)('Serverless Secrets beginning packaging process');
    this.serverless.service.package.include = (_this$serverless$serv = this.serverless.service.package.include) !== null && _this$serverless$serv !== void 0 ? _this$serverless$serv : [];
    await this.writeEnvironmentSecretToFile();
    this.serverless.service.package.include.push(this.secretsFile);
  }
}
exports.default = ServerlessSsmPlugin;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJTZXJ2ZXJsZXNzU3NtUGx1Z2luIiwiY29uc3RydWN0b3IiLCJzZXJ2ZXJsZXNzIiwib3B0aW9ucyIsImhvb2tzIiwicGFja2FnZVNlY3JldHMiLCJiaW5kIiwiY2xlYW51cFBhY2thZ2VTZWNyZXRzIiwicmVnaW9uIiwic2VydmljZSIsInByb3ZpZGVyIiwic2VjcmV0c0ZpbGUiLCJwcm9jZXNzIiwiZW52IiwiU0VDUkVUU19GSUxFX1BBVEgiLCJ3cml0ZUVudmlyb25tZW50U2VjcmV0VG9GaWxlIiwicHJvdmlkZXJTZWNyZXRzIiwiZW52aXJvbm1lbnQiLCJzZWNyZXRzIiwiY2xhc3NlcyIsIkVycm9yIiwicGFyYW0iLCJnZXRQYXJhbWV0ZXJGcm9tU3NtIiwiZnMiLCJwcm9taXNlcyIsIndyaXRlRmlsZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJuYW1lIiwiY2xpZW50IiwiU2VjcmV0c01hbmFnZXIiLCJwcm92aWRlcnMiLCJhd3MiLCJnZXRDcmVkZW50aWFscyIsImRhdGEiLCJnZXRTZWNyZXRWYWx1ZSIsIlNlY3JldElkIiwicHJvbWlzZSIsIlNlY3JldFN0cmluZyIsImxvZyIsImV4aXN0c1N5bmMiLCJ1bmxpbmsiLCJzdGFnZSIsInBhY2thZ2UiLCJpbmNsdWRlIiwicHVzaCJdLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgU2VjcmV0c01hbmFnZXIgfSBmcm9tICdhd3Mtc2RrJztcbmltcG9ydCBQbHVnaW4gZnJvbSAnc2VydmVybGVzcy9jbGFzc2VzL1BsdWdpbic7XG5pbXBvcnQgeyBsb2cgfSBmcm9tICdAc2VydmVybGVzcy91dGlscy9sb2cnO1xuXG5pbXBvcnQgeyBPcHRpb25zLCBTZXJ2ZXJsZXNzV2l0aEVycm9yIH0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNlcnZlcmxlc3NTc21QbHVnaW4gaW1wbGVtZW50cyBQbHVnaW4ge1xuICBob29rczogUGx1Z2luWydob29rcyddO1xuICBvcHRpb25zOiBPcHRpb25zO1xuICBzZXJ2ZXJsZXNzOiBTZXJ2ZXJsZXNzV2l0aEVycm9yO1xuICByZWdpb246IHN0cmluZztcbiAgcHVibGljIHNlY3JldHNGaWxlOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3Ioc2VydmVybGVzczogU2VydmVybGVzc1dpdGhFcnJvciwgb3B0aW9uczogT3B0aW9ucykge1xuICAgIHRoaXMuaG9va3MgPSB7XG4gICAgICAnYmVmb3JlOnBhY2thZ2U6Y3JlYXRlRGVwbG95bWVudEFydGlmYWN0cyc6IHRoaXMucGFja2FnZVNlY3JldHMuYmluZCh0aGlzKSxcbiAgICAgICdhZnRlcjpwYWNrYWdlOmNyZWF0ZURlcGxveW1lbnRBcnRpZmFjdHMnOiB0aGlzLmNsZWFudXBQYWNrYWdlU2VjcmV0cy5iaW5kKHRoaXMpLFxuICAgICAgJ2JlZm9yZTpkZXBsb3k6ZnVuY3Rpb246cGFja2FnZUZ1bmN0aW9uJzogdGhpcy5wYWNrYWdlU2VjcmV0cy5iaW5kKHRoaXMpLFxuICAgICAgJ2FmdGVyOmRlcGxveTpmdW5jdGlvbjpwYWNrYWdlRnVuY3Rpb24nOiB0aGlzLmNsZWFudXBQYWNrYWdlU2VjcmV0cy5iaW5kKHRoaXMpLFxuICAgICAgLy8gRm9yIHNlcnZlcmxlc3Mtb2ZmbGluZSBwbHVnaW5cbiAgICAgICdiZWZvcmU6b2ZmbGluZTpzdGFydDppbml0JzogdGhpcy5wYWNrYWdlU2VjcmV0cy5iaW5kKHRoaXMpLFxuICAgICAgJ2JlZm9yZTpvZmZsaW5lOnN0YXJ0OmVuZCc6IHRoaXMuY2xlYW51cFBhY2thZ2VTZWNyZXRzLmJpbmQodGhpcyksXG4gICAgICAvLyBGb3IgaW52b2tlIGxvY2FsXG4gICAgICAnYmVmb3JlOmludm9rZTpsb2NhbDppbnZva2UnOiB0aGlzLnBhY2thZ2VTZWNyZXRzLmJpbmQodGhpcyksXG4gICAgICAnYWZ0ZXI6aW52b2tlOmxvY2FsOmludm9rZSc6IHRoaXMuY2xlYW51cFBhY2thZ2VTZWNyZXRzLmJpbmQodGhpcyksXG4gICAgfTtcblxuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgdGhpcy5zZXJ2ZXJsZXNzID0gc2VydmVybGVzcztcbiAgICB0aGlzLnJlZ2lvbiA9IHNlcnZlcmxlc3Muc2VydmljZS5wcm92aWRlci5yZWdpb247XG4gICAgdGhpcy5zZWNyZXRzRmlsZSA9IHByb2Nlc3MuZW52LlNFQ1JFVFNfRklMRV9QQVRIID8/ICdzZWNyZXRzLmpzb24nO1xuICB9XG5cbiAgYXN5bmMgd3JpdGVFbnZpcm9ubWVudFNlY3JldFRvRmlsZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBwcm92aWRlclNlY3JldHMgPSB0aGlzLnNlcnZlcmxlc3Muc2VydmljZS5wcm92aWRlci5lbnZpcm9ubWVudFsnQVBJX0VOVl9TRUNSRVRfTkFNRSddIGFzIE1heWJlPHN0cmluZz47XG4gICAgY29uc3Qgc2VjcmV0czogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuXG4gICAgLy8gbW9kaWZ5IHRoaXMgZnVuY3Rpb24gdG8gcmV0dXJuIHRoZSBzZWNyZXRzXG4gICAgaWYgKCFwcm92aWRlclNlY3JldHMpIHtcbiAgICAgIHRocm93IG5ldyB0aGlzLnNlcnZlcmxlc3MuY2xhc3Nlcy5FcnJvcihgVW5hYmxlIHRvIGZpbmQgdGhlIGVudmlyb25tZW50IHZhcmlhYmxlIGZvciAke3Byb3ZpZGVyU2VjcmV0c31gKTtcbiAgICB9XG4gICAgY29uc3QgcGFyYW0gPSBhd2FpdCB0aGlzLmdldFBhcmFtZXRlckZyb21Tc20ocHJvdmlkZXJTZWNyZXRzKTtcblxuICAgIGlmICghcGFyYW0pIHtcbiAgICAgIHRocm93IG5ldyB0aGlzLnNlcnZlcmxlc3MuY2xhc3Nlcy5FcnJvcihgVW5hYmxlIHRvIGxvYWQgU2VjcmV0ICR7cHJvdmlkZXJTZWNyZXRzfWApO1xuICAgIH1cblxuICAgIHNlY3JldHNbcHJvdmlkZXJTZWNyZXRzXSA9IHBhcmFtO1xuXG4gICAgcmV0dXJuIGZzLnByb21pc2VzLndyaXRlRmlsZSh0aGlzLnNlY3JldHNGaWxlLCBKU09OLnN0cmluZ2lmeShzZWNyZXRzKSk7XG4gIH1cblxuICBhc3luYyBnZXRQYXJhbWV0ZXJGcm9tU3NtKG5hbWU6IHN0cmluZyk6IFByb21pc2U8TWF5YmU8c3RyaW5nPj4ge1xuICAgIGNvbnN0IGNsaWVudCA9IG5ldyBTZWNyZXRzTWFuYWdlcih7XG4gICAgICByZWdpb246IHRoaXMucmVnaW9uLFxuICAgICAgLi4udGhpcy5zZXJ2ZXJsZXNzLnByb3ZpZGVycy5hd3MuZ2V0Q3JlZGVudGlhbHMoKSxcbiAgICB9KTtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgY2xpZW50LmdldFNlY3JldFZhbHVlKHsgU2VjcmV0SWQ6IG5hbWUgfSkucHJvbWlzZSgpO1xuICAgIHJldHVybiBkYXRhLlNlY3JldFN0cmluZztcbiAgfVxuXG4gIGFzeW5jIGNsZWFudXBQYWNrYWdlU2VjcmV0cygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBsb2coYENsZWFuaW5nIHVwICR7dGhpcy5zZWNyZXRzRmlsZX1gKTtcbiAgICBpZiAoZnMuZXhpc3RzU3luYyh0aGlzLnNlY3JldHNGaWxlKSkge1xuICAgICAgYXdhaXQgZnMucHJvbWlzZXMudW5saW5rKHRoaXMuc2VjcmV0c0ZpbGUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHBhY2thZ2VTZWNyZXRzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLnNlcnZlcmxlc3Muc2VydmljZS5wcm92aWRlci5zdGFnZSA9PT0gJ2xvY2FsJykge1xuICAgICAgbG9nKCdTa2lwcGluZyBzZWNyZXQgcGFja2FnaW5nIGR1ZSB0byBzdGFnZSA9IGxvY2FsJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxvZygnU2VydmVybGVzcyBTZWNyZXRzIGJlZ2lubmluZyBwYWNrYWdpbmcgcHJvY2VzcycpO1xuICAgIHRoaXMuc2VydmVybGVzcy5zZXJ2aWNlLnBhY2thZ2UuaW5jbHVkZSA9IHRoaXMuc2VydmVybGVzcy5zZXJ2aWNlLnBhY2thZ2UuaW5jbHVkZSA/PyBbXTtcbiAgICBhd2FpdCB0aGlzLndyaXRlRW52aXJvbm1lbnRTZWNyZXRUb0ZpbGUoKTtcbiAgICB0aGlzLnNlcnZlcmxlc3Muc2VydmljZS5wYWNrYWdlLmluY2x1ZGUucHVzaCh0aGlzLnNlY3JldHNGaWxlKTtcbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTtBQUNBO0FBRUE7QUFBNEM7QUFBQTtBQUk3QixNQUFNQSxtQkFBbUIsQ0FBbUI7RUFPekRDLFdBQVcsQ0FBQ0MsVUFBK0IsRUFBRUMsT0FBZ0IsRUFBRTtJQUFBO0lBQUE7SUFBQTtJQUFBO0lBQUE7SUFBQTtJQUM3RCxJQUFJLENBQUNDLEtBQUssR0FBRztNQUNYLDBDQUEwQyxFQUFFLElBQUksQ0FBQ0MsY0FBYyxDQUFDQyxJQUFJLENBQUMsSUFBSSxDQUFDO01BQzFFLHlDQUF5QyxFQUFFLElBQUksQ0FBQ0MscUJBQXFCLENBQUNELElBQUksQ0FBQyxJQUFJLENBQUM7TUFDaEYsd0NBQXdDLEVBQUUsSUFBSSxDQUFDRCxjQUFjLENBQUNDLElBQUksQ0FBQyxJQUFJLENBQUM7TUFDeEUsdUNBQXVDLEVBQUUsSUFBSSxDQUFDQyxxQkFBcUIsQ0FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQztNQUM5RTtNQUNBLDJCQUEyQixFQUFFLElBQUksQ0FBQ0QsY0FBYyxDQUFDQyxJQUFJLENBQUMsSUFBSSxDQUFDO01BQzNELDBCQUEwQixFQUFFLElBQUksQ0FBQ0MscUJBQXFCLENBQUNELElBQUksQ0FBQyxJQUFJLENBQUM7TUFDakU7TUFDQSw0QkFBNEIsRUFBRSxJQUFJLENBQUNELGNBQWMsQ0FBQ0MsSUFBSSxDQUFDLElBQUksQ0FBQztNQUM1RCwyQkFBMkIsRUFBRSxJQUFJLENBQUNDLHFCQUFxQixDQUFDRCxJQUFJLENBQUMsSUFBSTtJQUNuRSxDQUFDO0lBRUQsSUFBSSxDQUFDSCxPQUFPLEdBQUdBLE9BQU87SUFDdEIsSUFBSSxDQUFDRCxVQUFVLEdBQUdB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